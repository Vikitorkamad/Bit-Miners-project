<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css"> 
    <title>A Minecraft Movie</title>
</head>

<!-- BARRA DE COOKIES -->
<div id="cookie-bar">
    <p>
      O site <strong>bitMiners</strong> usa cookies e outras tecnologias semelhantes para melhorar a sua experiência, personalizar conteúdo e anúncios, oferecer recursos de mídia social e analisar nosso tráfego.  
      Ao continuar navegando, você concorda com essas condições. Para mais informações, acesse nossa 
      <a href="seguranca-e-privacidade.html">Política de Privacidade</a>.
    </p>
  <div id="cookie-overlay" >

      <div>
        <p>Você precisa aceitar os cookies para usar o site.</p>
        <p>
          Para mais informações, consulte nossa 
          <a href="seguranca-e-privacidade.html">Política de Segurança e Privacidade</a>.
        </p>
        <br>
        <button onclick="aceitarCookies()">Aceitar cookies</button>
      </div>
  </div>
  </div>

<body>

<main>
    <header>
        <div class="topo">
            <img src="./img/topo.png" alt="">
        </div>
    </header>

    <section>
        <h2>Deixe a sua opinião sobre Um Filme Minecraft e ganhe um brinde</h2>
        <p>
            Assista ao filme, deixe sua opinião e ganhe prêmios exclusivos no Minecraft! Todos que
            participarem ganham um código para resgatar uma capa no jogo, e os 5 comentários mais
            criativos podem ganhar ingressos para o próximo filme! O comentário mais curtido ganha um 
            bônus colecionável do Creeper!
        </p>
        <div class="imaagens">
            <img src="./img/capa.png" alt="Capa" class="img1">
            <img src="./img/abelha.png" alt="Abelha" class="img2">
            <img src="./img/bloco.png" alt="Bloco" class="img3">
            <img src="./img/abelha.png" alt="Outra Abelha" class="img4">
        </div>
        
        <iframe 
        width="560"
        height="315"
        src="https://www.youtube.com/embed/3IVPHxs4NoM?si=t9HrLX68M-8WLln3"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen>
        </iframe>
    </section>

    <section name="comentarios">
        <h2>Melhores Comentários</h2>
        <div class="comentarios">
            <div class="ranking"></div>
            <div class="ranking"></div>
            <div class="ranking"></div>
            <div class="ranking"></div>
            <div class="ranking"></div>
        </div>
    </section>


    <section>
        <p id="texto-tempo">o tempo está acabando. DEIXE SEU COMENTÁRIO!!!</p>
        <p id="tempo">30:05:59:25</p>
        <h2>Deixe seu comentário aqui</h2>
        <div class="form-box">
            <div class="form-content">
                <form id="envioform" method="POST">
                    <input type="email" placeholder="Seu e-mail:" id="emailComentario" name="email" required>
                    <input type="text" placeholder="Nome de usuário visível:" id="username" name="username" required>
                    <textarea id="comment" placeholder="Comentário:" name="comment" rows="5" required></textarea>
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </div>
    </section>
    <section>

    <h2>Veja Comentários!</h2>
    <div id="comentariosDinamicos" class="comments-grid"></div>
</section>
    

    <h4 id="h4">Não recebeu seu código por e-mail?</h4>
    <div class="reenvio">
        <p>Nos repasse seu e-mail, e nossa equipe de suporte irá averiguar.</p>
        <form id="reenvio" method="POST">
            <input type="email" id="emailReenvio" name="email" placeholder="Seu e-mail:" required>
            <button type="submit">Enviar</button>
        </form>
    </div>
    <footer>
        <p>ainda precisa de ajuda? envie um email para <a href="mailto:suporte@bitminers.shop">suporte@bitminers.shop</a></p>
    </footer>
</main>

</body>
</html>
<script>
    let dias = 30, horas = 5, minutos = 59, segundos = 25;

    function atualizarTempo() {
        if (segundos > 0) {
            segundos--;
        } else {
            segundos = 59;
            if (minutos > 0) {
                minutos--;
            } else {
                minutos = 59;
                if (horas > 0) {
                    horas--;
                } else {
                    horas = 23;
                    if (dias > 0) {
                        dias--;
                    } else {
                        clearInterval(contador);
                        document.getElementById("texto-tempo").innerText = "O TEMPO ACABOU!";
                        return;
                    }
                }
            }
        }

        document.getElementById("tempo").innerText =
            String(dias).padStart(2, '0') + ":" +
            String(horas).padStart(2, '0') + ":" +
            String(minutos).padStart(2, '0') + ":" +
            String(segundos).padStart(2, '0');
    }

    let contador = setInterval(atualizarTempo, 1000);

    function setCookie(nome, valor, dias) {
        const d = new Date();
        d.setTime(d.getTime() + (dias * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = nome + "=" + valor + ";" + expires + ";path=/";
    }

    function getCookie(nome) {
        const nomeEQ = nome + "=";
        const ca = document.cookie.split(';');
        for (let c of ca) {
            while (c.charAt(0) === ' ') c = c.substring(1);
            if (c.indexOf(nomeEQ) === 0) return c.substring(nomeEQ.length);
        }
        return null;
    }

    function aceitarCookies() {
        setCookie("cookiesConsent", "aceito", 365);
        document.getElementById("cookie-bar").style.display = "none";
        document.getElementById("cookie-overlay").style.display = "none";
    }

    function rejeitarCookies() {
        setCookie("cookiesConsent", "rejeitado", 365);
        document.getElementById("cookie-bar").style.display = "none";
        document.getElementById("cookie-overlay").style.display = "flex";
    }

    function carregarComentarios() {
        fetch('http://localhost/bitMiners/buscarComentariosAleatorios.php')
            .then(res => res.text())
            .then(data => {
                console.log('Resposta bruta:', data);
                try {
                    const jsonData = JSON.parse(data);
                    const container = document.getElementById('comentariosDinamicos');
                    container.innerHTML = '';

                    jsonData.forEach((c, i) => {
                        const imgNumber = Math.floor(Math.random() * 10) + 1;
                        const avatarSrc = `./img/coment${imgNumber}.jpg`;
                        const key = btoa(encodeURIComponent(c.username + "_" + c.comment));


                        container.innerHTML += `
                        <div class="comentario-box">
                            <p><strong><img src="${avatarSrc}" alt="Avatar" /> ${c.username}</strong></p>
                            <p>${c.comment}</p>
                            <span class="likes">
                                <span class="likes-count" id="likes-count-${key}">${c.curtidas}</span>
                                <span class="fa fa-star" data-key="${key}"></span>
                            </span>
                        </div>`;
                    });

                    ativarLikes();
                } catch (error) {
                    console.error('Erro ao parsear JSON:', error);
                }
            })
            .catch(error => console.error('Erro na requisição:', error));
    }

    function carregarTopComentarios() {
        fetch('http://localhost/bitMiners/buscarComentariosMaisCurtidos.php')
            .then(res => res.text())
            .then(data => {
                console.log('Top curtidos brutos:', data);
                try {
                    const jsonData = JSON.parse(data);
                    const rankings = document.querySelectorAll(".ranking");

                    jsonData.slice(0, 5).forEach((c, i) => {
                        const rankingDiv = rankings[i];
                        const imgNumber = Math.floor(Math.random() * 10) + 1;
                        const avatarSrc = `./img/coment${imgNumber}.jpg`;

                        rankingDiv.innerHTML = `
                            <h3>${i + 1}º lugar</h3>
                            <div>
                                <p><strong><img src="${avatarSrc}" alt="Avatar" /> ${c.username}</strong></p>
                                <p>
                                    ${c.comment}
                                    </p>
                                <span class="top-likes">
                                    <span class="top-likes-count">${c.curtidas}</span>
                                    <span class="fa fa-star top-star"></span>
                                </span>
                            </div>
                        `;
                    });
                } catch (error) {
                    console.error('Erro ao parsear JSON de top curtidos:', error);
                }
            })
            .catch(error => console.error('Erro ao carregar top curtidos:', error));
    }


    function ativarLikes() {
    const stars = document.querySelectorAll("#comentariosDinamicos .fa-star");

    stars.forEach(function (star) {
        const key = star.getAttribute("data-key");
        const countSpan = document.getElementById("likes-count-" + key);
        const commentBox = star.closest(".comentario-box");
        const username = commentBox.querySelector("strong").textContent.trim();
        const cookieName = "starComent_" + key;
        const starState = getCookie(cookieName);

        if (starState === "clicked") {
            star.classList.add("checked");
        }

        star.addEventListener("click", async function () {
            const isChecked = this.classList.toggle("checked");
            let likes = parseInt(countSpan.textContent, 10);
            const valor = isChecked ? 1 : 0;

            // Atualiza visualmente
            likes = isChecked ? likes + 1 : Math.max(0, likes - 1);
            countSpan.textContent = likes;

            // Atualiza cookie
            setCookie(cookieName, isChecked ? "clicked" : "unclicked", 365);

            // Envia para o PHP
            const payload = {
                username: username,
                valor: valor
            };

            try {
                await fetch("http://localhost/bitMiners/likeDeslike.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error("Erro ao enviar like:", error);
            }
        });
    });
}



    window.onload = function () {
        const consent = getCookie("cookiesConsent");

        if (consent === "aceito") {
            document.getElementById("cookie-bar").style.display = "none";
            document.getElementById("cookie-overlay").style.display = "none";
        } else if (consent === "rejeitado") {
            document.getElementById("cookie-overlay").style.display = "flex";
        } else {
            document.getElementById("cookie-bar").style.display = "block";
            document.getElementById("cookie-overlay").style.display = "flex";
        }
    };

    document.addEventListener("DOMContentLoaded", function () {
        // Likes fixos do top 5
        carregarTopComentarios();
        const stars = document.querySelectorAll(".fa-star");
        stars.forEach(function (star, index) {
            const likesSpan = star.parentElement.querySelector(".likes-count");
            const starState = getCookie("starState" + index);

            if (starState === "clicked") {
                star.classList.add("checked");
            }

            star.addEventListener("click", function () {
                const isChecked = this.classList.toggle("checked");
                let likes = parseInt(likesSpan.textContent, 10);

                if (isChecked) {
                    likes += 1;
                    setCookie("starState" + index, "clicked", 365);
                } else {
                    likes = Math.max(0, likes - 1);
                    setCookie("starState" + index, "unclicked", 365);
                }

                likesSpan.textContent = likes;
            });
        });

        // Formulário de envio de comentário
        const form = document.getElementById('envioform');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailComentario').value.trim();
            const username = document.getElementById('username').value.trim();
            const comment = document.getElementById('comment').value.trim();
            const payload = { email, username, comment };

            try {
                const res = await fetch('http://localhost/bitMiners/entrarComentario.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = await res.text();
                console.log('Resposta bruta:', text);

                if (res.ok) {
                    const json = JSON.parse(text);
                    alert('Comentário enviado com sucesso! ID: ' + json.insertId);
                    form.reset();
                    carregarComentarios(); // Atualiza os comentários
                } else {
                    alert('Erro ao enviar comentário: ' + res.status);
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
                alert('Não foi possível comunicar com o servidor.');
            }
        });

        // Formulário de reenvio
        const form2 = document.getElementById('reenvio');
        form2.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailReenvio').value.trim();
            const payload = { email };

            try {
                const res = await fetch('http://localhost/bitMiners/enviarEmail.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const json = await res.json();
                    alert('Mensagem: funcionou por algum motivo ass:Pedro ' + json.insertId);
                    form2.reset();
                } else {
                    const err = await res.text();
                    alert('Mensagem: não funcionou por algum motivo ass:Pedro ' + res.status);
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
                alert('Não foi possível comunicar com o servidor.');
            }
        });

        // Carrega os comentários dinâmicos ao abrir a página
        carregarComentarios();
    });
</script>
